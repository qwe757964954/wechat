{"version":3,"sources":["file:///Users/mac/work/WXGame_FlySmallChick/assets/framework/layer/LayerPopup.ts"],"names":["LayerPopUp","BlockInputEvents","Color","ImageAsset","Layers","Node","Sprite","SpriteFrame","Texture2D","Widget","DelegateComponent","LayerUI","constructor","name","init","layer","Enum","UI_2D","black","getComponent","addComponent","enabled","reloadMaskSprite","regMaskTouch","color","width","height","count","data","Uint8Array","j","r","g","b","a","imageAsset","reset","_data","_compressed","format","PixelFormat","RGBA8888","texture","image","spriteFrame","packable","node","_maskNode","getChildByName","sprite","create_2DNode","w","isAlignLeft","isAlignRight","isAlignTop","isAlignBottom","left","right","top","bottom","alignMode","addChild","trim","sizeMode","type","on","EventType","TOUCH_END","onTouchMaskEnd","event","children","length","topChild","active","isValid","delegateComponent","viewParams","isClickSpanceClose","destroy","add","config","params","popParams","isAutoRecover","updateMaskState","remove","prefabPath","isDestroy","removeByUuid","toDestoryNotNotify","off","clear"],"mappings":"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","sourcesContent":["/**\n * Name = LayerPopup\n * URL = db://assets/framework/layer/LayerPopup.ts\n * Time = Thu Apr 14 2022 12:03:00 GMT+0800 (中国标准时间)\n * Author = xueya\n * Pop弹窗\n */\nimport { BlockInputEvents, Color, EventTouch, ImageAsset, Layers, Node, Sprite, SpriteFrame, Texture2D, Widget } from \"cc\";\nimport { inf_PopViewParams, inf_UIConfig, inf_ViewParams } from \"../InterfaceDefines\";\nimport { DelegateComponent } from \"./DelegateComponent\";\nimport { LayerUI } from \"./LayerUI\";\n\n/*\n * Popup层，调用add显示，可以显示暗色背景，弹框参数可以查看PopViewParams\n * 允许同时弹出多个不同资源文件的窗口(同一个则禁止弹出)\n */\nexport class LayerPopUp extends LayerUI {\n    protected black!: BlockInputEvents;\n\n    constructor(name: string) {\n        super(name);\n    }\n\n    protected init() {\n        super.init();\n        //背景\n        this.layer = Layers.Enum.UI_2D;\n        //防穿透\n        this.black = this.getComponent(BlockInputEvents);\n        if (!this.black) {\n            this.black = this.addComponent(BlockInputEvents);\n        }\n        this.black.enabled = false;\n        this.reloadMaskSprite();\n        this.regMaskTouch();\n    }\n    /** 重新加载maskNode蒙版(子节点) */\n    protected reloadMaskSprite(color:Color = new Color(0, 0, 0, 150)) {\n        let width = 100;\n        let height = 100;\n\n        let count = width * height * 4;\n        let data: any = new Uint8Array(count);\n        for (var j = 0; j < count; j += 4) {\n            data[j] = color.r // r\n            data[j + 1] = color.g // g\n            data[j + 2] = color.b // b\n            data[j + 3] = color.a // a\n        }\n        let imageAsset = new ImageAsset();\n        imageAsset.reset({\n            _data: data,\n            _compressed: false,\n            width: width,\n            height: height,\n            format: Texture2D.PixelFormat.RGBA8888\n        });\n\n        let texture = new Texture2D();\n        texture.reset({\n            width: width,\n            height: height,\n            format: Texture2D.PixelFormat.RGBA8888\n        })\n        texture.image = imageAsset;\n\n        let spriteFrame = new SpriteFrame();\n        spriteFrame.texture = texture;\n        //需要禁用其纹理的 packable 选项 不参与自动合图\n        spriteFrame.packable = false;\n        //节点\n        let node = this._maskNode.getChildByName(\"Sprite\");\n        let sprite: Sprite = null;\n        if (!node) {\n            node = this.create_2DNode(\"Sprite\");\n            let w: Widget = node.addComponent(Widget);\n            w.isAlignLeft = w.isAlignRight = w.isAlignTop = w.isAlignBottom = true;\n            w.left = w.right = w.top = w.bottom = 0;\n            w.alignMode = 2;\n            w.enabled = true;\n\n            sprite = node.addComponent(Sprite);\n            sprite.enabled = true;\n\n            this._maskNode.addChild(node);\n        } else {\n            sprite = node.getComponent(Sprite);\n        }\n        sprite.trim = true;\n        sprite.sizeMode = 0;\n        sprite.type = 0;\n        sprite.spriteFrame = spriteFrame;\n\n    }\n\n    /** 注册遮罩层的点击事件 */\n    protected regMaskTouch() {\n        this._maskNode.on(Node.EventType.TOUCH_END, this.onTouchMaskEnd, this);\n    }\n    /** 遮罩层的点击事件 */\n    protected onTouchMaskEnd(event: EventTouch) {\n        if (this.children.length >= 2) {\n            let topChild = this.children[this.children.length - 1];\n            if (topChild && topChild.active == true && topChild.isValid == true) {\n                let delegateComponent = topChild.getComponent(DelegateComponent);\n                if (delegateComponent) {\n                    let viewParams: inf_ViewParams = delegateComponent.viewParams;\n                    if (viewParams && viewParams.isClickSpanceClose == true) {\n                        topChild.destroy();\n                    }\n                }\n            }\n        }\n    }\n    /**\n     * 添加一个预制件节点到PopUp层容器中，该方法将返回一个唯一uuid来标识该操作节点\n     * @param prefabPath 预制件路径\n     * @param params     传给组件onAdded、onRemoved方法的参数。\n     * @param popParams  弹出界面的设置定义，详情见PopViewParams\n     * @param isClickSpanceClose 是否点击自动关闭 默认 false 不关闭\n     * @param isAutoRecover 是否自动释放加载的资源 默认false不释放\n     */\n    add(config: inf_UIConfig, params: any, popParams?: inf_PopViewParams, isClickSpanceClose?: boolean, isAutoRecover?: boolean): string {\n        this.black.enabled = true;\n        return super.add(config, params, popParams, isClickSpanceClose, isAutoRecover);\n    }\n    /** 更新遮罩层点击状态 */\n    protected updateMaskState() {\n        super.updateMaskState()\n        if (this.isValid == false || !this._maskNode) {\n            return;\n        }\n        this.black.enabled = this._maskNode.active;\n    }\n\n    /**\n     * 根据预制体路径移除\n     * @param prefabPath 预制体路径\n     * @param isDestroy 是否销毁\n     */\n    remove(prefabPath: string, isDestroy: boolean): void {\n        super.remove(prefabPath, isDestroy);\n        if (this.isValid == false) {\n            return\n        }\n        this.black.enabled = false;\n    }\n    /**\n     * 根据预制体唯一UUID移除\n     * @param prefabPath 预制体路径\n     * @param isDestroy 是否销毁\n     */\n    removeByUuid(prefabPath: string, isDestroy: boolean): void {\n        super.removeByUuid(prefabPath, isDestroy);\n        if (this.isValid == false) {\n            return\n        }\n        this.black.enabled = false;\n    }\n\n    /**\n     * 执行销毁,不发送通知\n     */\n    toDestoryNotNotify() {\n        if (this._maskNode && this._maskNode.isValid == true) {\n            this._maskNode.off(Node.EventType.TOUCH_END, this.onTouchMaskEnd, this);\n        }\n        super.toDestoryNotNotify();\n        if (this.isValid == false) {\n            return\n        }\n        this.init();\n        this.regMaskTouch();\n    }\n    clear(isDestroy: boolean) {\n        super.clear(isDestroy)\n        if (this.isValid == false) {\n            return\n        }\n        this.black.enabled = false;\n        this.active = false;\n    }\n}"]}