{"version":3,"sources":["file:///Users/mac/work/WXGame_FlySmallChick/assets/framework/audio/AudioMusic.ts"],"names":["AudioClip","AudioSource","error","_decorator","resLoader","ccclass","menu","AudioMusic","constructor","onComplete","_progress","_bundle","_path","_isPause","_isStopPlay","_isStartPlay","_currowVolume","progress","currentTime","duration","value","initData","clip","stop","load","bundleName","path","callback","isPlay","console","log","playing","startPause","startPlay","state","self","err","data","realLoadAudioClip","call","audioClip","node","isValid","AudioState","INTERRUPTED","startStop","release","volume","PLAYING","isPause","PAUSED","play","pause","updatePauseState","setVolume","num","Number","isNaN"],"mappings":"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","sourcesContent":["import { AudioClip, AudioSource, error, _decorator } from 'cc';\nimport { resLoader } from '../loader/ResLoader';\nconst { ccclass, menu } = _decorator;\n\n/** 背景音乐 */\n@ccclass('AudioMusic')\nexport class AudioMusic extends AudioSource {\n    public onComplete: Function | null = null;\n\n    private _progress: number = 0;\n    private _bundle: string = \"resources\";\n    private _path: string | null = null;\n\n    /** 是否处于暂停中 */\n    private _isPause: boolean = false;\n    /** 是否停止了播放 */\n    private _isStopPlay: boolean = false;\n    /** 是否播放阶段 */\n    private _isStartPlay: boolean = false;\n    /** 当前音量 */\n    private _currowVolume: number = 1;\n\n    constructor() {\n        super();\n    }\n    /**\n     * 设置音乐当前播放进度\n     * @param progress 进度百分比(0~1)\n     */\n    public get progress() {\n        this._progress = this.currentTime / this.duration;\n        return this._progress;\n    }\n    public set progress(value: number) {\n        this._progress = value;\n        this.currentTime = value * this.duration;\n    }\n\n    initData() {\n        /** 是否处于暂停中 */\n        this._isPause = false;\n        /** 是否停止了播放 */\n        this._isStopPlay = false;\n        /** 是否播放阶段 */\n        this._isStartPlay = false;\n        if (this.clip) {\n            this.stop();\n        }\n        this.clip = null;\n    }\n\n    public load(bundleName: string = \"resources\", path: string, callback?: Function) {\n        //针对同一音频不再重复播放\n        if (this._path == path && this._bundle == bundleName) {\n            if (this.isPlay() == true) {\n                if (callback) {\n                    callback();\n                }\n                console.log(\"针对同一音频不再重复播放--->\", 1, this._isPause)\n                return;\n            } else {\n                if (this.clip) {\n                    if (this._isPause == false) {\n                        if (this.playing == false) {//此处有可能为中断\n                            this.startPause();\n                            this.startPlay();\n                        }\n                    }\n                    if (callback) {\n                        callback();\n                    }\n                    console.log(\"针对同一音频不再重复播放--->\", 2, this._isPause, this.playing, this.state)\n                    return;\n                }\n            }\n        }\n        this._isStopPlay = false;\n        this._isStartPlay = true;\n        // console.log(\" 开始播放===>\", path)\n        let self = this;\n\n        resLoader.load(bundleName, path, AudioClip, (err: Error | null, data: AudioClip) => {\n            if (err) {\n                error(err);\n            }\n            self.realLoadAudioClip.call(self, bundleName, path, data, callback);\n        });\n    }\n\n    /** 真正的加载包 */\n    private realLoadAudioClip(bundleName, path, audioClip: AudioClip, callback?: Function) {\n        this._isStartPlay = false;\n        if (!this.node || this.node.isValid == false) {\n            return;\n        }\n        if (this._isStopPlay == true) {\n            return;\n        }\n        if (this.playing || this.state == AudioSource.AudioState.INTERRUPTED) {\n            this.startStop();\n            if (this._path != path && this._bundle != bundleName) {\n                resLoader.release(this._path!, this._bundle);\n            }\n        }\n        this.clip = audioClip;\n        this.currentTime = 0;\n        this.volume = this._currowVolume;\n        if (this._isPause == false) {\n            this.startPlay();\n        }\n        if (callback) {\n            callback();\n        }\n\n        this._path = path;\n        this._bundle = bundleName\n    }\n\n    /** 是否处于播放阶段 */\n    isPlay(): boolean {\n        if (this._isStartPlay) {\n            return true;\n        }\n        return this.state == AudioSource.AudioState.PLAYING;\n    }\n    /** 是否处于暂停阶段 */\n    isPause(): boolean {\n        return this.state == AudioSource.AudioState.PAUSED;\n    }\n\n    /** 播放 */\n    startPlay() {\n        this.play();\n        this._isPause = false;\n    }\n    /** 暂停 */\n    startPause() {\n        this.pause();\n        this._isPause = true;\n    }\n    /** 停止 */\n    startStop() {\n        this.stop();\n        this._isStopPlay = true;\n    }\n    /** 更新暂停状态 */\n    updatePauseState(state: boolean) {\n        this._isPause = state || false;\n    }\n    /** 设置音量 0~1 */\n    setVolume(num: number) {\n        num = Number(num);\n        if (isNaN(num)) {\n            return;\n        }\n        if (num > 1) {\n            num = 1;\n        } else if (num < 0) {\n            num = 0;\n        }\n        this._currowVolume = num;\n        if (this.isPlay() || this.isPause()) {\n            this.volume = this._currowVolume;\n        }\n\n    }\n    release() {\n        if (this._path) {\n            resLoader.release(this._path, this._bundle);\n            this._path = null;\n            this._bundle = \"resources\"\n        }\n        this.startStop();\n        this._isPause = false;\n    }\n}\n"]}