{"version":3,"sources":["file:///Users/mac/work/WXGame_FlySmallChick/assets/cache/PropsConf.ts"],"names":["PropsConf","StoreKey","LocalStorage","Utils","Encrypt","HttpRequest","BaseCache","constructor","superClass","__User","_PropsUrlConf","_BaseProps","_UnionProps","setPropsBaseUrlConf","conf","console","log","getPropsBaseUrlConf","downloadAndSavePropsConf","url","key","count","warn","keyArr","PROPS_BASE_CONF","PROPS_UNION_CONF","flag","indexOf","string_isEmpty","http","self","complete","response","jsonStr","get","oldTime","oldConf","JsonDecode","number_valueOf","GoodsBase","timestamp","obj","table_isEmpty","set","error","getIconPre","getPropsConfTime","time","initDataByLocal","getBaseProps","getUnionProps","str","table_verify","getPropsInfoById","id","baseProps","baseConf","Object","prototype","hasOwnProperty","call","info","iconpre","pre","unionProps","unionConf"],"mappings":"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","sourcesContent":["import { StoreKey } from \"../config/GameConstant\";\nimport { LocalStorage } from \"../framework/LocalStorage\";\nimport { Utils } from \"../framework/Utils\";\nimport { Encrypt } from \"../framework/crypto/Encrypto\";\nimport { HttpRequest } from \"../framework/network/HttpRequest\";\nimport { BaseCache } from \"../framework/vc/BaseCache\";\nimport { User } from \"./User\";\n\nexport class PropsConf extends BaseCache {\n    \n    /** 用户类 */\n    private __User: User = null;\n    \n    /** 物品图片相关配置 */\n    private _PropsUrlConf = {};\n    \n    /** 基本道具配置 */\n    private _BaseProps = {};\n    \n    /** 额外道具配置 */\n\tprivate _UnionProps = {};\n\t\n\t\n\t//实例化\n\tconstructor(superClass) {\n\t\tsuper(\"PropsConf\");\n\t\tthis.__User = superClass;\n    };\n\n    /**\n\t * 设置图片相关配置\n\t * @param conf \n\t */\n\tsetPropsBaseUrlConf(conf) {\t\t\n\t\tconsole.log(\"打印相关:\",conf)\n\t\tthis._PropsUrlConf = conf;\n\t}\n    \n\t/**\n\t * 获取图片相关配置\n\t * @returns \n\t */\n\tgetPropsBaseUrlConf() {\n\t\treturn this._PropsUrlConf;\n\t}\n\n\t/**\n\t * 下载配置并保存到本地\n\t * @param url \n\t * @param key \n\t * @returns \n\t */\n\tdownloadAndSavePropsConf(url: string, key: string, count = 0) {\n\t\tif (count >= 3) { \n\t\t\tconsole.warn(\"downloadAndSavePropsConf:\"+url,\"请求失败 3次都失败 不再请求\")\n\t\t\treturn;\n\t\t}\n\t\tconsole.log(\"测试加载图片配置:\",key)\t\n\t\tlet keyArr=[StoreKey.PROPS_BASE_CONF,StoreKey.PROPS_UNION_CONF]\n\t\tlet flag=keyArr.indexOf(key)\n\t\tif (flag==-1 || Utils.string_isEmpty(key)) {\n\t\t\treturn;\n\t\t}\n        let http = new HttpRequest();\n\t\tlet self = this;\n\t\t\n\t\tlet complete = function (response) {\n\t\t\tconsole.log(\"http get complete\",key)\n\t\t\tif (response) {\n\t\t\t\tlet jsonStr = LocalStorage.get(key, '');\n\t\t\t\tlet oldTime = 0;\n\t\t\t\t\n\t\t\t\tif (!Utils.string_isEmpty(jsonStr)) {\n\t\t\t\t\tlet oldConf = Encrypt.JsonDecode(jsonStr)\n\t\t\t\t\toldTime = Utils.number_valueOf(oldConf.GoodsBase.timestamp, 0)\n\t\t\t\t}\n\t\t\t\tlet obj = Encrypt.JsonDecode(response);\n\t\t\t\tif (Utils.table_isEmpty(obj)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tlet timestamp = Utils.number_valueOf(obj.GoodsBase.timestamp, 0);\n\t\t\t\tif (timestamp > 0 && timestamp > oldTime) {\n\t\t\t\t\tLocalStorage.set(key, response);\n\t\t\t\t\tif (key == StoreKey.PROPS_BASE_CONF) {\n\t\t\t\t\t\tself._BaseProps = obj;\n\t\t\t\t\t} else if (key == StoreKey.PROPS_UNION_CONF) {\n\t\t\t\t\t\tself._UnionProps = obj;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else { \n\t\t\t\tself.downloadAndSavePropsConf(url, key,count+1);\n\t\t\t}\n        }\n        let error = function(response){\n\t\t\tconsole.log(\"http get error\", response, key);\n\t\t\tself.downloadAndSavePropsConf(url, key,count+1);\n        }\t\n\t\thttp.get(url, complete, error);\n\t}\n\n\t/**\n     * 获取图片域名\n     * @returns \n     */\n\tgetIconPre() {\n\t\tlet url = this._PropsUrlConf[\"icon_pre\"];\n\t\treturn url;\n\t}\n\n\t/**\n\t * 获取最近拉取的时间戳\n\t * @returns \n\t */\n\tgetPropsConfTime(key: string) {\n\t\tconsole.log(\"测试加载图片配置时间\")\t\n\t\tlet keyArr=[StoreKey.PROPS_BASE_CONF,StoreKey.PROPS_UNION_CONF]\n\t\tlet flag = keyArr.indexOf(key)\n\t\tlet time = 0;\t\n\t\tif (flag!=-1) {\n\t\t\tlet jsonStr = LocalStorage.get(key, '')\n\t\t\tlet conf = Encrypt.JsonDecode(jsonStr)\n\t\t\tif (!Utils.table_isEmpty(conf)) {\n\t\t\t\ttime = Utils.number_valueOf(conf.GoodsBase.timestamp, 0)\n\t\t\t}\t\t\n\t\t}\n\t\treturn time;\n\t}\n\t/** 本地缓存读取 */\n\tinitDataByLocal() { \n\t\tthis.getBaseProps();\n\t\tthis.getUnionProps();\n\t}\n\t/**\n     * 获取基本道具配置\n     * @returns \n     */\n\tgetBaseProps() {\n\t\tlet key = StoreKey.PROPS_BASE_CONF;\n\t\tif (Utils.table_isEmpty(this._BaseProps)) {\n            console.log(\"走缓存\")\n            let str = LocalStorage.get(key);\n            let obj = Encrypt.JsonDecode(str);\n\t\t\tthis._BaseProps = Utils.table_verify(obj);\n\t\t}\n\t\tif (Utils.table_isEmpty(this._BaseProps)) {\n\t\t\tthis._BaseProps = {};\n\t\t}\n\t\treturn this._BaseProps;\t\n\t}\n\n\n\n\n\n    /**\n     * 获取额外道具配置\n     * @returns \n     */\n\tgetUnionProps() {\n\t\tlet key = StoreKey.PROPS_UNION_CONF;\n        if (Utils.table_isEmpty(this._UnionProps)) {\n            let str = LocalStorage.get(key);\n            let obj = Encrypt.JsonDecode(str);\n            this._UnionProps = obj;\n\t\t}\n\t\tif (Utils.table_isEmpty(this._UnionProps)) {\n\t\t\tthis._UnionProps = {};\n\t\t}\n        return this._UnionProps;\n    }\n    \n\t\n\t\n    /**\n     * 获取道具信息\n     * @param id 道具ID\n     * @returns \n     */\n\tgetPropsInfoById(id) {\n\t\t//https://dfqppic.266.com/dfqp/images/goods/dev/0/0.png\n\t\tid = Utils.number_valueOf(id);\n\t\tlet baseProps = this.getBaseProps();\n\t\tif (Utils.table_isEmpty( baseProps['GoodsBase']) ) {\n\t\t\treturn {};\n\t\t}\n\t\tlet baseConf = baseProps['GoodsBase']['list'];\n\t\tif (Utils.table_isEmpty(baseConf)) {\n\t\t\treturn {};\n\t\t}\n\t\tif (Object.prototype.hasOwnProperty.call(baseConf,id)) {\n\t\t\tlet info = baseConf[id];\n\t\t\tlet iconpre = this.getIconPre();\n\t\t\tlet pre = id % 10\n\t\t\tlet url = iconpre + pre + '/' + id + '.png?v=' + info.timestamp\n\t\t\tinfo.url=url\n\t\t\treturn info;\n\t\t}\n\t\tlet unionProps = this.getUnionProps();\n\t\tif (Utils.table_isEmpty( unionProps['GoodsBase']) ) {\n\t\t\treturn {};\n\t\t}\n\t\tlet unionConf = unionProps['GoodsBase']['list'];\n\t\tif (Utils.table_isEmpty(unionConf)) {\n\t\t\treturn {};\n\t\t}\n\t\tif (Object.prototype.hasOwnProperty.call(unionConf,id)) {\n\t\t\tlet info = baseConf[id];\n\t\t\tlet iconpre = this.getIconPre();\n\t\t\tlet pre = id % 10\n\t\t\tlet url = iconpre + pre + '/' + id + '?v=' + info.timestamp\n\t\t\tinfo.url=url\n\t\t\treturn info;\n\t\t}\n\t\treturn {}\n    }\n    \n    \n}"]}