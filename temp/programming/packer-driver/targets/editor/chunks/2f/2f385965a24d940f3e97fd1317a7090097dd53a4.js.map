{"version":3,"sources":["file:///Users/mac/work/WXGame_FlySmallChick/assets/cache/WatchMessage.ts"],"names":["WatchMessage","AppEvent","GConstants","StoreKey","LocalStorage","EventManager","Utils","BaseCache","constructor","superClass","__User","__MailInfo","MailInfo","getMaxId","msgList","maxId","i","length","v","num","number_valueOf","dealData","arr","isArray","data","item","Object","prototype","hasOwnProperty","call","is_html","push","table_isEmpty","tmp","k","v1","status","MsgStatus","MSG_STATUS_FRESH","saveMaxEmailId","saveDataFromNet","dispatch","NOTIFY_EMAIL_CHANGE","key_SystemLastId","string_format","WATCH_MESSAGE_SYSTEMID","getUserMid","systemLastId","get","currentMaxId","set"],"mappings":"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","sourcesContent":["/**\n * Name = WatchMessage\n * URL = db://assets/cache/WatchMessage.ts\n * Time = Mon May 09 2022 14:43:04 GMT+0800 (中国标准时间)\n * Author = xueya\n * 信箱数据缓存\n */\n\nimport { AppEvent } from \"../config/AppEvent\";\nimport { GConstants, StoreKey } from \"../config/GameConstant\";\nimport { LocalStorage } from \"../framework/LocalStorage\";\nimport { EventManager } from \"../framework/manager/EventManager\";\nimport { Utils } from \"../framework/Utils\";\nimport { BaseCache } from \"../framework/vc/BaseCache\";\nimport { MailInfo } from \"./MailInfo\";\nimport { User } from \"./User\";\n\nexport class WatchMessage extends BaseCache {\n\n    /** 用户类 */\n    private __User: User = null;\n\n    /** 邮件类 */\n    private __MailInfo: MailInfo = null;\n\n\n    //实例化\n    constructor(superClass) {\n        super(\"WatchMessage\");\n        this.__User = superClass;\n        this.__MailInfo = this.__User.MailInfo;\n    };\n\n    getMaxId(msgList): number {\n        let maxId = 0;\n        for (let i = 0; i < msgList.length; i++) {\n            let v = msgList[i];\n            let num = Utils.number_valueOf(v[\"id\"])\n            if (num > maxId) {\n                maxId = num;\n            }\n        }\n        return maxId\n    }\n\n    /**处理数据*/\n    dealData(arr) {\n        if (!Utils.isArray(arr)) {\n            return;\n        }\n        let data = [];\n        for (let item of arr) {\n            if (Object.prototype.hasOwnProperty.call(item, \"is_html\") && Utils.number_valueOf(item.is_html, 0) > 0) {\n                continue;\n            }\n            data.push(item);\n        }\n        if (Utils.table_isEmpty(data)) {\n            return;\n        }\n        let tmp = []\n        for (let k = 0; k < data.length; k++) {\n            let v1 = data[k];\n            //初始化邮件状态\n            v1.status = GConstants.MsgStatus.MSG_STATUS_FRESH\n            tmp.push(v1)\n        }\n        this.saveMaxEmailId(tmp)\n        this.__User.MailInfo.saveDataFromNet(tmp)\n        //有新数据刷新邮件界面\n        EventManager.dispatch(AppEvent.NOTIFY_EMAIL_CHANGE);\n    }\n    /**\n     * 存储邮件最大ID\n     * @param msgList \n     */\n    saveMaxEmailId(msgList) {\n        //当前本地存储的ID\n        let key_SystemLastId = Utils.string_format(StoreKey.WATCH_MESSAGE_SYSTEMID, this.__User.getUserMid());\n        let systemLastId = LocalStorage.get(key_SystemLastId, 0);\n        let currentMaxId = this.getMaxId(msgList);\n        if (currentMaxId > systemLastId) {\n            LocalStorage.set(key_SystemLastId, currentMaxId);\n        }\n    }\n}"]}