{"version":3,"sources":["file:///Users/mac/work/WXGame_FlySmallChick/assets/proj/GameController.ts"],"names":["GameController","GCache","AppEvent","GConstants","UIConfigData","UIID","LayerManager","EventManager","Utils","BaseControll","GlobalCMD","GlobalHeadCmdBinding","GPBWriteAndRead","_reportGameVerRecord","getInstance","_instance","init","clear","onInitModuleEvent","addModelListener","GAME_GOTO_SHOW","showGame","GAME_GOTO_EXIT","exitGame","NET_REQ_GAME_PLAY_INFO","reqGamePlayInfo","NET_RECEIVE_GAME_PLAY_INFO","respGamePlayInfo","NET_REQ_REPORT_GAME_VERSION","reqReportGameVer","event","User","isLoginSuccesed","has","GameScenePrefab","isLoading","dispatch","SYS_CLOSE_NETLOADING","SYS_UPDATE_CMDMAPPING","Write","initCommonCmd","Read","SYS_PACKAGE_LOAD","PkgLoaderTaskList","Game","clearOther","layer","print","SYS_APP_LIFE","AppRunLife","Game_Will_Open","VIEW_UI_OPEN","onAdded","VIEW_UI_MAIN_UPDATE","Game_Opened","onRemoved","Game_Closed","ROOM_VIEW_ONLOAD","isLogining","NET_GOTO_START_LOGIN","Hall","HALL_GOTO_SHOW","gameID","number_valueOf","isNull","ver","SelectGame","getGameVersionByGameID","param","gid","gameVer","sendMsg","cmd","PHP_REPORT_GAME_VERSION","body","NET_SEND_MSG","game_id","PHP_GAME_PLAY_INFO","isSuccess","respData","reqData","dump","result","syncGamePlayRecord","USER_UPDATE_GAMERECORD"],"mappings":"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","sourcesContent":["/**\n * Name = GameController\n * URL = db://assets/proj/GameController.ts\n * Time = Fri Apr 29 2022 14:08:39 GMT+0800 (中国标准时间)\n * Author = xueya\n * 游戏控制器\n */\nimport { GCache } from \"../cache/GCache\";\nimport { AppEvent } from \"../config/AppEvent\";\nimport { GConstants } from \"../config/GameConstant\";\nimport { UIConfigData, UIID } from \"../config/UIConfig\";\nimport { LayerManager } from \"../framework/layer/LayerManager\";\nimport { EventManager } from \"../framework/manager/EventManager\";\nimport { Utils } from \"../framework/Utils\";\nimport { BaseControll } from \"../framework/vc/BaseController\";\nimport { GlobalCMD, GlobalHeadCmdBinding } from \"./gnet/GlobalCMD\";\nimport { GPBWriteAndRead } from \"./gnet/GPBWriteAndRead\";\n\n\nexport class GameController extends BaseControll {\n\t//上报游戏版本记录\n\t_reportGameVerRecord = {};\n\n\tprivate static _instance = null;\n\tpublic static getInstance(): GameController {\n\t\tif (!this._instance || this._instance == null) {\n\t\t\tthis._instance = new GameController(\"GameController\");\n\t\t}\n\t\treturn this._instance;\n\t}\n\tpublic static init(): GameController {\n\t\tif (this._instance) {\n\t\t\tthis._instance.clear()\n\t\t}\n\t\tthis._instance = null\n\t\tGameController.getInstance()\n\t\treturn\n\t}\n\t/**初始化添加事件绑定 */\n\tprotected onInitModuleEvent(): void {\n\t\t//显示游戏场景\n\t\tthis.addModelListener(AppEvent.GAME_GOTO_SHOW, this.showGame)\n\t\t//退出游戏场景\n\t\tthis.addModelListener(AppEvent.GAME_GOTO_EXIT, this.exitGame)\n\t\t//请求玩家玩某个游戏的信息\n\t\tthis.addModelListener(AppEvent.NET_REQ_GAME_PLAY_INFO, this.reqGamePlayInfo);\n\t\t//玩家玩某个游戏的信息返回\n\t\tthis.addModelListener(AppEvent.NET_RECEIVE_GAME_PLAY_INFO, this.respGamePlayInfo);\n\n\t\t//请求上报子游戏版本号\n\t\tthis.addModelListener(AppEvent.NET_REQ_REPORT_GAME_VERSION, this.reqReportGameVer)\n\n\t}\n\t//显示游戏界面\n\tshowGame(event) {\n\t\t//此处要判断用户是否登录成功\n\t\tif (GCache.User.isLoginSuccesed()) {\n\t\t\t// console.warn(\"是否正在加载:\", LayerManager.isLoading(UIID.GameScenePrefab))\n\t\t\tif (!LayerManager.has(UIID.GameScenePrefab) && !LayerManager.isLoading(UIID.GameScenePrefab)) {\n\t\t\t\t//关闭网络加载\n\t\t\t\tEventManager.dispatch(AppEvent.SYS_CLOSE_NETLOADING);\n\t\t\t\t//初始化绑定绑定映射\n\t\t\t\tEventManager.dispatch(AppEvent.SYS_UPDATE_CMDMAPPING);\n\t\t\t\tGPBWriteAndRead.Write.initCommonCmd(GlobalHeadCmdBinding, true);\n\t\t\t\tGPBWriteAndRead.Read.initCommonCmd(GlobalHeadCmdBinding, true);\n\t\t\t\tEventManager.dispatch(AppEvent.SYS_PACKAGE_LOAD, GConstants.PkgLoaderTaskList.Game, () => {\n\t\t\t\t\tif (GCache.User.isLoginSuccesed() == false) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tif (LayerManager.has(UIID.GameScenePrefab) || LayerManager.isLoading(UIID.GameScenePrefab) == true) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tLayerManager.clearOther(UIConfigData[UIID.GameScenePrefab].layer);\n\t\t\t\t\tLayerManager.clear(UIConfigData[UIID.GameScenePrefab].layer);\n\n\t\t\t\t\tthis.print(\"打开游戏场景===>\")\n\t\t\t\t\t//通知:sys周期变化\n\t\t\t\t\tEventManager.dispatch(AppEvent.SYS_APP_LIFE, GConstants.AppRunLife.Game_Will_Open);\n\t\t\t\t\tEventManager.dispatch(AppEvent.VIEW_UI_OPEN, UIID.GameScenePrefab, null, {\n\t\t\t\t\t\tonAdded: function () {\n\t\t\t\t\t\t\t//通知:主场景更换\n\t\t\t\t\t\t\tEventManager.dispatch(AppEvent.VIEW_UI_MAIN_UPDATE, UIID.GameScenePrefab);\n\t\t\t\t\t\t\t//通知:sys周期变化\n\t\t\t\t\t\t\tEventManager.dispatch(AppEvent.SYS_APP_LIFE, GConstants.AppRunLife.Game_Opened);\n\t\t\t\t\t\t},\n\t\t\t\t\t\tonRemoved: function () {\n\t\t\t\t\t\t\t//通知:sys周期变化\n\t\t\t\t\t\t\tEventManager.dispatch(AppEvent.SYS_APP_LIFE, GConstants.AppRunLife.Game_Closed);\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t})\n\t\t\t} else {\n\t\t\t\tthis.print(\"游戏场景已存在，强制刷新===>\")\n\t\t\t\tEventManager.dispatch(AppEvent.ROOM_VIEW_ONLOAD);\n\t\t\t}\n\t\t} else {\n\t\t\t//正在登录中\n\t\t\tif (GCache.User.isLogining()) {\n\t\t\t\treturn\n\t\t\t}\n\t\t\t//重新登录\n\t\t\tLayerManager.clear(null);\n\n\t\t\tEventManager.dispatch(AppEvent.NET_GOTO_START_LOGIN)\n\t\t}\n\t}\n\n\t//关闭游戏界面\n\texitGame() {\n\t\tif (LayerManager.has(UIID.GameScenePrefab) || LayerManager.isLoading(UIID.GameScenePrefab)) {\n\t\t\tLayerManager.clear(null, true);\n\t\t\t//初始化绑定绑定映射\n\t\t\tEventManager.dispatch(AppEvent.SYS_UPDATE_CMDMAPPING);\n\t\t\tGPBWriteAndRead.Write.initCommonCmd(GlobalHeadCmdBinding, true);\n\t\t\tGPBWriteAndRead.Read.initCommonCmd(GlobalHeadCmdBinding, true);\n\t\t\tEventManager.dispatch(AppEvent.SYS_PACKAGE_LOAD, GConstants.PkgLoaderTaskList.Hall, () => {\n\t\t\t\tif (GCache.User.isLoginSuccesed() == false) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tEventManager.dispatch(AppEvent.HALL_GOTO_SHOW, true);\n\t\t\t})\n\t\t}\n\t}\n\t//请求上报子游戏版本号\n\treqReportGameVer(event, gameID) {\n\t\tgameID = Utils.number_valueOf(gameID, null)\n\t\tif (Utils.isNull(gameID)) {\n\t\t\treturn\n\t\t}\n\t\tif (!Utils.isNull(this._reportGameVerRecord[gameID])) {\n\t\t\t//每一个游戏只上报一次\n\t\t\treturn\n\t\t}\n\t\tlet ver = Utils.number_valueOf(GCache.SelectGame.getGameVersionByGameID(gameID), null)\n\t\tif (Utils.isNull(ver)) {\n\t\t\treturn\n\t\t}\n\t\tlet param = {\n\t\t\tgid: gameID,\n\t\t\tgameVer: ver\n\t\t};\n\t\tlet sendMsg = {\n\t\t\tcmd: GlobalCMD.PHP_REPORT_GAME_VERSION,\n\t\t\tbody: param,\n\t\t}\n\t\tEventManager.dispatch(AppEvent.NET_SEND_MSG, sendMsg)\n\n\t\tthis._reportGameVerRecord[gameID] = Utils.number_valueOf(this._reportGameVerRecord[gameID], 0) + 1\n\t}\n\t//请求php获取用户某个游戏的信息\n\treqGamePlayInfo(event, gameID: Number) {\n\t\tgameID = Utils.number_valueOf(gameID, null);\n\t\tif (Utils.isNull(gameID)) {\n\t\t\treturn\n\t\t}\n\t\tlet param = {\n\t\t\tgame_id: gameID,\n\t\t};\n\t\tlet sendMsg = {\n\t\t\tcmd: GlobalCMD.PHP_GAME_PLAY_INFO,\n\t\t\tbody: param,\n\t\t}\n\t\tEventManager.dispatch(AppEvent.NET_SEND_MSG, sendMsg);\n\t}\n\t//php获取用户某个游戏的信息\n\trespGamePlayInfo(event, isSuccess, respData, reqData) {\n\t\tthis.dump(respData, \"php获取用户某个游戏的信息返回\" + isSuccess)\n\t\tif (isSuccess == false) {\n\t\t\treturn;\n\t\t}\n\t\tlet result = GCache.User.syncGamePlayRecord(respData[\"game_id\"], respData);\n\t\tif (result != null) {\n\t\t\t//玩局记录有更新\n\t\t\tEventManager.dispatch(AppEvent.USER_UPDATE_GAMERECORD, result);\n\t\t}\n\t}\n}\n\n"]}