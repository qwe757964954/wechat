{"version":3,"sources":["file:///Users/mac/work/WXGame_FlySmallChick/assets/package/game/module/match/src/Match.ts"],"names":["Layout","Prefab","_decorator","EventManager","Utils","BaseComponent","PlayerMgr","RoomMgr","FXJEvent","FXJRes","GameEvent","CardUtil","Player","ccclass","property","Match","tooltip","type","willAddPlayer","playerList","_handlerTimeUpdate","onInitModuleEvent","addModelListener","VIEW_BROADCAST_PLAYER_ENTER","addPlayer","VIEW_BROADCAST_PLAYER_EXIT","onPalyerExit","onLoad","resetPlayer","loadPlayerList","startMatchTime","stopSchedulerOnce","addSchedulerOnce","handler","resetView","onReady","getInstance","getMyPlayerInfo","isReady","dispatch","NET_REQ_PLAYER_READY","layoutPlayerList","node","removeAllChildren","forEach","player","showPlayer","start","seatId","calculatePlayerSeat","mySeatId","isValid","console","warn","scriptPlayer","getComponent","updatePlayerProperty","getPreLoaderRes","Prefab_Match_Player","bundle","path","nodeRes","addChild","updateLayout","log","hidenPlayer","removeFromParent","event","uid","findPlayerWithUserId","deletePlayer"],"mappings":"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","sourcesContent":["\nimport { Layout, Node, Prefab, _decorator } from 'cc';\nimport { EventManager } from '../../../../../framework/manager/EventManager';\nimport { Utils } from '../../../../../framework/Utils';\nimport { BaseComponent } from '../../../../../framework/vc/BaseComponent';\nimport { PlayerMgr } from '../../../cache/PlayerMgr';\nimport { RoomMgr } from '../../../cache/RoomMgr';\nimport { FXJEvent } from '../../../common/FXJEvent';\nimport { FXJRes } from '../../../common/FXJRes';\nimport { GameEvent } from '../../../common/GameEvent';\nimport { Common } from '../../../common/idl/Common';\nimport { CardUtil } from '../../../util/CardUtil';\nimport { Player } from './Player';\n\nconst { ccclass, property } = _decorator;\n\n/**\n * Name = match\n * URL = db://assets/package/game/module/match/src/match.ts\n * Time = Fri Aug 04 2023 11:18:15 GMT+0800 (中国标准时间)\n * Author = qwe757964\n *\n * Life: onLoad-->onInitModuleEvent-->onEnable->start->update->lateUpdate->onDisable->onDestroy\n * \n */\nexport interface Coordinate {\n\tx: number;\n\ty: number;\n}\n\n\n\n@ccclass('Match')\nexport class Match extends BaseComponent {\n\n\t//开始游戏按钮节点\n\t@property({ tooltip: \"玩家人物容器\", type: Layout })\n\tprivate layoutPlayerList: Layout | null = null;\n\n\tprivate willAddPlayer: { [key: number]: boolean } = {};\n\tprivate playerList: { [key: number]: Node } = {};\n\n\t/** 时间更新句柄 */\n\t_handlerTimeUpdate = null;\n\n\t/** override 初始化模块事件 */\n\tprotected onInitModuleEvent() {\n\t\tthis.addModelListener(GameEvent.VIEW_BROADCAST_PLAYER_ENTER, this.addPlayer);\n\t\tthis.addModelListener(GameEvent.VIEW_BROADCAST_PLAYER_EXIT, this.onPalyerExit);\n\t};\n\n\tonLoad() {\n\t\tthis.resetPlayer();\n\t\tthis.loadPlayerList();\n\t\t\n\t\tthis.startMatchTime();\n\t};\n\n\tstartMatchTime() {\n\t\tthis.stopSchedulerOnce(this._handlerTimeUpdate);\n\t\tthis._handlerTimeUpdate = null;\n\t\tthis._handlerTimeUpdate = this.addSchedulerOnce(0.5, Utils.handler(this, this.resetView))\n\t}\n\n\tresetView(){\n\t\tthis.onReady();\n\t}\n\n\tonReady() {\n\t\tif (!PlayerMgr.getInstance().getMyPlayerInfo().isReady) {\n\t\t\tEventManager.dispatch(FXJEvent.NET_REQ_PLAYER_READY);\n\t\t}\n\t}\n\n\tresetPlayer() {\n\t\tthis.playerList = {};\n\t\tthis.layoutPlayerList.node.removeAllChildren();\n\t}\n\n\n\tpublic loadPlayerList() {\n\t\tPlayerMgr.getInstance().playerList.forEach(player => {\n\t\t\tthis.showPlayer(player);\n\t\t});\n\t}\n\n\n\tstart() {\n\n\n\t};\n\n\tshowPlayer(player: Common.IPlayerInfo) {\n\t\tlet seatId: number = CardUtil.calculatePlayerSeat(RoomMgr.getInstance().mySeatId, player.seatId);\n\t\tif (this.playerList[seatId]) {\n\t\t\tif (this.playerList[seatId].isValid == false) {\n\t\t\t\tthis.playerList[seatId] = null;\n\t\t\t}\n\t\t}\n\t\tif (this.playerList[seatId]) {\n\t\t\tconsole.warn(\"玩家匹配 座位号重复，player\");\n\t\t\tlet scriptPlayer: Player = this.playerList[seatId].getComponent(Player);\n\t\t\tscriptPlayer.updatePlayerProperty(player);\n\t\t\treturn;\n\t\t}\n\t\tthis.willAddPlayer[seatId] = true;\n\t\tthis.getPreLoaderRes(FXJRes.Prefab_Match_Player.bundle, FXJRes.Prefab_Match_Player.path, Prefab, (nodeRes) => {\n\t\t\tif (this.willAddPlayer[seatId] != true) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tdelete this.willAddPlayer[seatId];\n\n\t\t\tthis.layoutPlayerList.node.addChild(nodeRes);\n\t\t\tthis.layoutPlayerList.updateLayout();\n\t\t\tthis.playerList[seatId] = nodeRes;\n\n\t\t\tlet scriptPlayer: Player = nodeRes.getComponent(Player);\n\t\t\tscriptPlayer.updatePlayerProperty(player);\n\t\t\tconsole.log(\"this.playerList______________add\", this.playerList);\n\t\t})\n\n\t}\n\thidenPlayer(player: Common.IPlayerInfo) {\n\t\tlet seatId: number = CardUtil.calculatePlayerSeat(RoomMgr.getInstance().mySeatId, player.seatId);\n\t\tif (this.playerList[seatId]) {\n\t\t\tif (this.playerList[seatId].isValid == false) {\n\t\t\t\tthis.playerList[seatId] = null;\n\t\t\t}\n\t\t}\n\t\tif (!this.playerList[seatId]) {\n\t\t\treturn;\n\t\t}\n\t\tlet scriptPlayer: Player = this.playerList[seatId].getComponent(Player);\n\t\tif (scriptPlayer.seatId === player.seatId) {\n\t\t\tdelete this.willAddPlayer[seatId];\n\t\t\tthis.playerList[seatId].removeFromParent();\n\t\t\tthis.playerList[seatId] = null;\n\t\t\t// this.playerList = this.playerList.filter(item => item.seatId === player.seatId);\n\t\t\tconsole.log(\"this.playerList______________delete\", this.playerList);\n\t\t}\n\t\tthis.layoutPlayerList.updateLayout();\n\t}\n\n\taddPlayer(event, uid) {\n\t\tlet player: Common.IPlayerInfo = PlayerMgr.getInstance().findPlayerWithUserId(uid);\n\t\tthis.showPlayer(player);\n\t}\n\tonPalyerExit(event, uid) {\n\t\tlet player = PlayerMgr.getInstance().findPlayerWithUserId(uid);\n\t\tthis.deletePlayer(player);\n\t}\n\n\n\tpublic deletePlayer(player: Common.IPlayerInfo) {\n\t\tthis.hidenPlayer(player);\n\t}\n}\n\n"]}