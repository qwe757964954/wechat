{"version":3,"sources":["file:///Users/mac/work/WXGame_FlySmallChick/assets/cache/PropsConf.ts"],"names":["PropsConf","ClientInfo","StoreKey","Encrypt","LocalStorage","HttpRequest","Utils","BaseCache","constructor","superClass","__User","_PropsUrlConf","_BaseProps","_UnionProps","setPropsBaseUrlConf","conf","console","log","getPropsBaseUrlConf","downloadAndSavePropsConf","url","key","count","warn","keyArr","PROPS_BASE_CONF","PROPS_UNION_CONF","flag","indexOf","string_isEmpty","realkey","CurrowServer","http","self","complete","response","jsonStr","get","oldTime","oldConf","JsonDecode","number_valueOf","GoodsBase","timestamp","obj","table_isEmpty","set","error","getIconPre","getPropsConfTime","time","initDataByLocal","getBaseProps","getUnionProps","str","table_verify","getPropsInfoById","id","baseProps","baseConf","Object","prototype","hasOwnProperty","call","info","iconpre","pre","unionProps","unionConf"],"mappings":"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","sourcesContent":["import { ClientInfo } from \"../config/GameConfig\";\nimport { StoreKey } from \"../config/GameConstant\";\nimport { Encrypt } from \"../framework/crypto/Encrypto\";\nimport { LocalStorage } from \"../framework/LocalStorage\";\nimport { HttpRequest } from \"../framework/network/HttpRequest\";\nimport { Utils } from \"../framework/Utils\";\nimport { BaseCache } from \"../framework/vc/BaseCache\";\nimport { User } from \"./User\";\n\nexport class PropsConf extends BaseCache {\n\n\t/** 用户类 */\n\tprivate __User: User = null;\n\n\t/** 物品图片相关配置 */\n\tprivate _PropsUrlConf = {};\n\n\t/** 基本道具配置 */\n\tprivate _BaseProps = {};\n\n\t/** 额外道具配置 */\n\tprivate _UnionProps = {};\n\n\n\t//实例化\n\tconstructor(superClass) {\n\t\tsuper(\"PropsConf\");\n\t\tthis.__User = superClass;\n\t};\n\n\t/**\n\t * 设置图片相关配置\n\t * @param conf \n\t */\n\tsetPropsBaseUrlConf(conf) {\n\t\tconsole.log(\"打印相关:\", conf)\n\t\tthis._PropsUrlConf = conf;\n\t}\n\n\t/**\n\t * 获取图片相关配置\n\t * @returns \n\t */\n\tgetPropsBaseUrlConf() {\n\t\treturn this._PropsUrlConf;\n\t}\n\n\t/**\n\t * 下载配置并保存到本地\n\t * @param url \n\t * @param key \n\t * @returns \n\t */\n\tdownloadAndSavePropsConf(url: string, key: string, count = 0) {\n\t\tif (count >= 3) {\n\t\t\tconsole.warn(\"downloadAndSavePropsConf:\" + url, \"请求失败 3次都失败 不再请求\")\n\t\t\treturn;\n\t\t}\n\t\tconsole.log(\"测试加载图片配置:\", key)\n\t\tlet keyArr = [StoreKey.PROPS_BASE_CONF, StoreKey.PROPS_UNION_CONF]\n\t\tlet flag = keyArr.indexOf(key)\n\t\tif (flag == -1 || Utils.string_isEmpty(key)) {\n\t\t\treturn;\n\t\t}\n\t\tlet realkey = key + \"_\" + ClientInfo.CurrowServer;\n\t\tlet http = new HttpRequest();\n\t\tlet self = this;\n\n\t\tlet complete = function (response) {\n\t\t\tconsole.log(\"http get complete\", key)\n\t\t\tif (response) {\n\t\t\t\tlet jsonStr = LocalStorage.get(realkey, '');\n\t\t\t\tlet oldTime = 0;\n\n\t\t\t\tif (!Utils.string_isEmpty(jsonStr)) {\n\t\t\t\t\tlet oldConf = Encrypt.JsonDecode(jsonStr)\n\t\t\t\t\toldTime = Utils.number_valueOf(oldConf.GoodsBase.timestamp, 0)\n\t\t\t\t}\n\t\t\t\tlet obj = Encrypt.JsonDecode(response);\n\t\t\t\tif (Utils.table_isEmpty(obj)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tlet timestamp = Utils.number_valueOf(obj.GoodsBase.timestamp, 0);\n\t\t\t\tif (timestamp > 0 && timestamp > oldTime) {\n\t\t\t\t\tLocalStorage.set(realkey, response);\n\t\t\t\t\tif (key == StoreKey.PROPS_BASE_CONF) {\n\t\t\t\t\t\tself._BaseProps = obj;\n\t\t\t\t\t} else if (key == StoreKey.PROPS_UNION_CONF) {\n\t\t\t\t\t\tself._UnionProps = obj;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tself.downloadAndSavePropsConf(url, key, count + 1);\n\t\t\t}\n\t\t}\n\t\tlet error = function (response) {\n\t\t\tconsole.log(\"http get error\", response, key);\n\t\t\tself.downloadAndSavePropsConf(url, key, count + 1);\n\t\t}\n\t\thttp.get(url, complete, error);\n\t}\n\n\t/**\n\t * 获取图片域名\n\t * @returns \n\t */\n\tgetIconPre() {\n\t\tlet url = this._PropsUrlConf[\"icon_pre\"];\n\t\treturn url;\n\t}\n\n\t/**\n\t * 获取最近拉取的时间戳\n\t * @returns \n\t */\n\tgetPropsConfTime(key: string) {\n\t\tconsole.log(\"测试加载图片配置时间\")\n\t\tlet keyArr = [StoreKey.PROPS_BASE_CONF, StoreKey.PROPS_UNION_CONF]\n\t\tlet flag = keyArr.indexOf(key)\n\t\tlet time = 0;\n\t\tif (flag != -1) {\n\t\t\tlet jsonStr = LocalStorage.get(key + \"_\" + ClientInfo.CurrowServer, '')\n\t\t\tlet conf = Encrypt.JsonDecode(jsonStr)\n\t\t\tif (!Utils.table_isEmpty(conf)) {\n\t\t\t\ttime = Utils.number_valueOf(conf.GoodsBase.timestamp, 0)\n\t\t\t}\n\t\t}\n\t\treturn time;\n\t}\n\t/** 本地缓存读取 */\n\tinitDataByLocal() {\n\t\tthis.getBaseProps();\n\t\tthis.getUnionProps();\n\t}\n\t/**\n\t * 获取基本道具配置\n\t * @returns \n\t */\n\tgetBaseProps() {\n\t\tlet key = StoreKey.PROPS_BASE_CONF + \"_\" + ClientInfo.CurrowServer;\n\t\tif (Utils.table_isEmpty(this._BaseProps)) {\n\t\t\tlet str = LocalStorage.get(key);\n\t\t\tlet obj = Encrypt.JsonDecode(str);\n\t\t\tthis._BaseProps = Utils.table_verify(obj);\n\t\t}\n\t\tif (Utils.table_isEmpty(this._BaseProps)) {\n\t\t\tthis._BaseProps = {};\n\t\t}\n\t\treturn this._BaseProps;\n\t}\n\t/**\n\t * 获取额外道具配置\n\t * @returns \n\t */\n\tgetUnionProps() {\n\t\tlet key = StoreKey.PROPS_UNION_CONF + \"_\" + ClientInfo.CurrowServer;\n\t\tif (Utils.table_isEmpty(this._UnionProps)) {\n\t\t\tlet str = LocalStorage.get(key);\n\t\t\tlet obj = Encrypt.JsonDecode(str);\n\t\t\tthis._UnionProps = obj;\n\t\t}\n\t\tif (Utils.table_isEmpty(this._UnionProps)) {\n\t\t\tthis._UnionProps = {};\n\t\t}\n\t\treturn this._UnionProps;\n\t}\n\n\n\n\t/**\n\t * 获取道具信息\n\t * @param id 道具ID\n\t * @returns \n\t */\n\tgetPropsInfoById(id) {\n\t\t//https://dfqppic.266.com/dfqp/images/goods/dev/0/0.png\n\t\tid = Utils.number_valueOf(id);\n\t\tlet baseProps = this.getBaseProps();\n\t\tif (Utils.table_isEmpty(baseProps['GoodsBase'])) {\n\t\t\treturn {};\n\t\t}\n\t\tlet baseConf = baseProps['GoodsBase']['list'];\n\t\tif (Utils.table_isEmpty(baseConf)) {\n\t\t\treturn {};\n\t\t}\n\t\tif (Object.prototype.hasOwnProperty.call(baseConf, id)) {\n\t\t\tlet info = baseConf[id];\n\t\t\tlet iconpre = this.getIconPre();\n\t\t\tlet pre = id % 10\n\t\t\tlet url = iconpre + pre + '/' + id + '.png?v=' + info.timestamp\n\t\t\tinfo.url = url\n\t\t\treturn info;\n\t\t}\n\t\tlet unionProps = this.getUnionProps();\n\t\tif (Utils.table_isEmpty(unionProps['GoodsBase'])) {\n\t\t\treturn {};\n\t\t}\n\t\tlet unionConf = unionProps['GoodsBase']['list'];\n\t\tif (Utils.table_isEmpty(unionConf)) {\n\t\t\treturn {};\n\t\t}\n\t\tif (Object.prototype.hasOwnProperty.call(unionConf, id)) {\n\t\t\tlet info = baseConf[id];\n\t\t\tlet iconpre = this.getIconPre();\n\t\t\tlet pre = id % 10\n\t\t\tlet url = iconpre + pre + '/' + id + '?v=' + info.timestamp\n\t\t\tinfo.url = url\n\t\t\treturn info;\n\t\t}\n\t\treturn {}\n\t}\n\n\n}"]}