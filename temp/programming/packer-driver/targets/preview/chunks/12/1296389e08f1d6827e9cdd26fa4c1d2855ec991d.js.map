{"version":3,"sources":["file:///Users/mac/work/WXGame_FlySmallChick/assets/framework/manager/SpineAniManager.ts"],"names":["assetManager","error","sp","Vec3","_decorator","AppEvent","LayerManager","Utils","BaseControll","ccclass","SpineAniManager","_skinAniMapping","getInstance","_instance","init","clear","onInitModuleEvent","addModelListener","SYS_ANI_PLAY","startPlayAni","SYS_ANI_STOP","stopPlayAni","preLoadSkinAniDir","bundle","dirPath","upFunc","cb","filePathList","String","split","preKey","length","self","loadBundle","err","print","loadDir","SkeletonData","finished","total","item","data","i","fileName","keyName","preLoadSkinAniDirList","list","updateFunc","resConf","isNotNull","prefab","event","param","aniName","isLoop","isPremult","toPos","trackIndex","parentNode","AnimNode","setSpineAni","skin","callStartFunc","callEndFunc","oneLoopEndcallFunc","processCallFunc","frameNum","key","path","aniNode","getSpineNode","isValid","AniNodeMap","set","parent","destroy","node","get","removeSpineNode","resData","name","loop","premultipliedAlpha","pos","startCallFunc","endCallFunc","oneLoopEndCallFunc","oldAniNode","getChildByName","create_2DNode","addComponent","Skeleton","setAniData","position","x","y","z","addChild","filePathName","string_splitFileName","skinData","isEndCallback","doCallback","skeleton","getComponent","skeletonData","setSkin","setStartListener","trackEntry","setEndListener","setCompleteListener","setEventListener","ev","Number","updateAnimation","_interval","_max_frame","dt","setAnimation","Map"],"mappings":"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","sourcesContent":["import { assetManager, error, Node, sp, Vec3, _decorator } from 'cc';\nimport { AppEvent } from '../../config/AppEvent';\nimport { inf_SpineAniCreate, inf_UIConfig } from '../InterfaceDefines';\nimport { LayerManager } from '../layer/LayerManager';\nimport { Utils } from '../Utils';\nimport { BaseControll } from '../vc/BaseController';\nconst { ccclass } = _decorator;\n\n/**\n * Name = SpineAniManager\n * URL = db://assets/framework/manager/SpineAniManager.ts\n * Time = Tue Sep 20 2022 14:20:23 GMT+0800 (中国标准时间)\n * Author = Tomoe\n *\n * Life: onLoad-->onEnable->start->update->lateUpdate->onDisable->onDestroy\n */\n\n@ccclass('SpineAniManager')\nexport class SpineAniManager extends BaseControll {\n\n\tprivate static _instance: SpineAniManager;\n\tpublic static getInstance(): SpineAniManager {\n\t\tif (!this._instance || this._instance == null) {\n\t\t\tthis._instance = new SpineAniManager(\"SpineAniManager\");\n\t\t}\n\t\treturn this._instance;\n\t}\n\t/** 骨骼动画资源映射 */\n\tprivate _skinAniMapping = {};\n\t/** 当前播放的动画节点队列 */\n\tstatic AniNodeMap: Map<string, Node> = new Map();\n\n\tpublic static init(): SpineAniManager {\n\t\tif (this._instance) {\n\t\t\tthis._instance.clear();\n\t\t}\n\t\tthis._instance = null\n\t\tSpineAniManager.getInstance();\n\t\treturn\n\t}\n\n\t/** 初始化模块事件 */\n\tprotected onInitModuleEvent() {\n\t\t//播放动画\n\t\tthis.addModelListener(AppEvent.SYS_ANI_PLAY, this.startPlayAni);\n\t\t//停止播放动画\n\t\tthis.addModelListener(AppEvent.SYS_ANI_STOP, this.stopPlayAni);\n\t}\n\t/**\n\t * 加载骨骼动画目录\n\t * @param bundle 包名\n\t * @param dirPath 根目录文件夹名\n\t * @param upFunc 进度更新\n\t * @param cb 完成回调\n\t */\n\tpublic preLoadSkinAniDir(bundle: string, dirPath: string, upFunc: Function = null, cb: Function = null) {\n\t\tif (dirPath == null || dirPath == \"\") {\n\t\t\treturn;\n\t\t}\n\t\tlet filePathList = String(dirPath).split(\"/\");\n\t\t//包名|根目录|文件名 or 包名|文件名\n\t\tlet preKey = bundle;\n\t\tif (filePathList.length > 1) {\n\t\t\tdirPath = filePathList[0];\n\t\t\tpreKey = preKey + \"|\" + dirPath;\n\t\t}\n\n\n\t\tconst self = this;\n\n\t\t// 自动加载bundle\n\t\tassetManager.loadBundle(bundle, (err, bundle) => {\n\t\t\tif (err) {\n\t\t\t\tself.print(\"加载包名出错\", err);\n\t\t\t\tif (cb) {\n\t\t\t\t\tcb(err, bundle);\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tbundle.loadDir(dirPath, sp.SkeletonData,\n\t\t\t\t(finished: number, total: number, item) => {\n\t\t\t\t\tif (upFunc) {\n\t\t\t\t\t\tupFunc(finished, total, item);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t(err, data: any) => {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tself.print(err);\n\t\t\t\t\t\tif (cb) {\n\t\t\t\t\t\t\tcb(err, data);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tfor (let i = 0; i < data.length; i++) {\n\t\t\t\t\t\tif (data[i][\"_name\"] != null) {\n\t\t\t\t\t\t\tlet fileName = data[i][\"_name\"];//文件名\n\t\t\t\t\t\t\tlet keyName = preKey + \"|\" + fileName;\n\t\t\t\t\t\t\tself._skinAniMapping[keyName] = data[i];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (cb) {\n\t\t\t\t\t\tcb(null, data);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t})\n\t}\n\n\t/**\n\t * 批量预加载骨骼动画目录\n\t * @param list inf_UIConfig的Array集合\n\t * @param cb 根目录文件夹名\n\t */\n\tpublic preLoadSkinAniDirList(list: Array<inf_UIConfig>, updateFunc: Function = null, cb: Function = null) {\n\t\tif (!list || list?.length <= 0) {\n\t\t\treturn;\n\t\t}\n\t\t// this.print(\"开始预加载\", list)\n\t\tfor (let i = 0; i < list.length; i++) {\n\t\t\tlet resConf: inf_UIConfig = list[i];\n\t\t\tif (Utils.isNotNull(resConf.bundle, resConf.prefab)) {\n\t\t\t\tthis.preLoadSkinAniDir(resConf.bundle, resConf.prefab, updateFunc, cb);\n\t\t\t}\n\t\t}\n\t}\n\n\t/** 播放动画 */\n\tprivate startPlayAni(event, param: inf_SpineAniCreate) {\n\t\tif (!param || !param.resConf || !param.aniName) {\n\t\t\treturn;\n\t\t};\n\t\tif (param.isLoop == null) {\n\t\t\tparam.isLoop = false;\n\t\t}\n\t\tif (param.isPremult == null) {\n\t\t\tparam.isPremult = false;\n\t\t}\n\t\tif (param.toPos == null) {\n\t\t\tparam.toPos = new Vec3(0, 0, 0);\n\t\t}\n\t\tif (param.trackIndex == null) {\n\t\t\tparam.trackIndex = 0;\n\t\t}\n\t\tif (!param.parentNode) {\n\t\t\tparam.parentNode = LayerManager.AnimNode;\n\t\t}\n\t\tthis.setSpineAni(\n\t\t\tparam.parentNode,\n\t\t\tparam.resConf,\n\t\t\tparam.trackIndex,\n\t\t\tparam.aniName,\n\t\t\tparam.isLoop,\n\t\t\tparam.isPremult,\n\t\t\tparam.skin,\n\t\t\tparam.toPos,\n\t\t\tparam.callStartFunc,\n\t\t\tparam.callEndFunc,\n\t\t\tparam.oneLoopEndcallFunc,\n\t\t\tparam.processCallFunc,\n\t\t\tparam.frameNum\n\t\t);\n\t}\n\t/** 停止动画 */\n\tprivate stopPlayAni(event, param: inf_SpineAniCreate) {\n\t\tif (!param || !param.resConf || !param.aniName) {\n\t\t\treturn;\n\t\t};\n\t\tlet key = param.resConf.bundle + \"|\" + param.resConf.path + \"|\" + param.aniName;\n\t\tlet aniNode = this.getSpineNode(key);\n\t\tif (!aniNode || aniNode.isValid == false) {\n\t\t\tSpineAniManager.AniNodeMap.set(key, null);\n\t\t\treturn;\n\t\t}\n\t\tif (aniNode.parent != param.parentNode) {\n\t\t\treturn;\n\t\t}\n\t\tif (aniNode.isValid == true) {\n\t\t\taniNode.destroy();\n\t\t}\n\t\tSpineAniManager.AniNodeMap.set(key, null);\n\t}\n\t/** 获取已添加动画节点 */\n\tpublic getSpineNode(key: string): Node | null {\n\t\tif (key && key != null) {\n\t\t\tlet node = SpineAniManager.AniNodeMap.get(key);\n\t\t\treturn node;\n\t\t}\n\t\treturn null\n\t}\n\t/** 移除已添加动画节点 */\n\tpublic removeSpineNode(aniNode: Node) {\n\t\tlet key = null;\n\t\tif (aniNode && aniNode[\"Anikey\"]) {\n\t\t\tkey = aniNode[\"Anikey\"];\n\t\t\tif (aniNode.isValid == true) {\n\t\t\t\taniNode.destroy();\n\t\t\t}\n\t\t\tSpineAniManager.AniNodeMap.set(key, null);\n\t\t}\n\t}\n\n\n\t/**\n\t * 设置动画节点\n\t * @param aniNode 要添加的父节点\n\t * @param resData {bundle:包名 path:路径}\n\t * @param trackIndex {播放的帧位置}\n\t * @param name 动画名\n\t * @param loop 是否循环 默认 false 不循环\n\t * @param premultipliedAlpha 是否预乘 默认 false 不预乘\n\t * @param skin 皮肤\n\t * @param pos Vec3类型 添加的位置\n\t * @param startCallFunc Function 开始播放的回调函数\n\t * @param endCallFunc Function 结束的回调函数\n\t * @param oneLoopEndCallFunc 一次循环结束的回调函数\n\t * @param processCallFunc 执行过程中的动作监听\n\t * @param frameNum 帧刷\n\t */\n\tpublic setSpineAni(aniNode: Node, resData, trackIndex: number, name: string, loop: boolean = false, premultipliedAlpha: boolean = false, skin: string = null, pos: Vec3 = null, startCallFunc: Function = null, endCallFunc: Function = null, oneLoopEndCallFunc: Function = null, processCallFunc: Function = null, frameNum: number = null): Node {\n\t\tlet key = resData.bundle + \"|\" + resData.path + \"|\" + name;\n\t\tif (!aniNode || aniNode.isValid == false) {\n\t\t\terror(\"设置动画节点 节点不存在或已销毁 资源Key = \" + key)\n\t\t\treturn;\n\t\t}\n\t\tlet oldAniNode = aniNode.getChildByName(key);\n\t\tif (oldAniNode) {\n\t\t\toldAniNode.destroy();\n\t\t}\n\t\tlet node: Node = Utils.create_2DNode(key);\n\t\tnode.addComponent(sp.Skeleton);\n\t\tthis.setAniData(node, resData, trackIndex, name, loop, premultipliedAlpha, skin, startCallFunc, endCallFunc, oneLoopEndCallFunc, processCallFunc, frameNum)\n\t\tif (pos) {\n\t\t\tnode.position = new Vec3(pos.x, pos.y, pos.z);\n\t\t}\n\t\taniNode.addChild(node);\n\t\t//标识\n\t\tnode[\"Anikey\"] = key;\n\t\tSpineAniManager.AniNodeMap.set(key, node);\n\t\treturn node;\n\t}\n\n\t//动画播放配置\n\tprivate setAniData(node: Node, resData, trackIndex: number, name: string, loop: boolean, premultipliedAlpha: boolean, skin: string = null, startCallFunc: Function = null, endCallFunc: Function = null, oneLoopEndCallFunc: Function = null, processCallFunc: Function = null, frameNum: number = null) {\n\t\tlet filePathName = Utils.string_splitFileName(resData.path);\n\t\tlet filePathList = String(resData.path).split(\"/\");\n\n\t\t//包名|根目录|文件名 or 包名|文件名\n\t\tlet key = resData.bundle;\n\t\tif (filePathList.length > 1) {\n\t\t\tkey = key + \"|\" + filePathList[0] + \"|\" + filePathName;\n\t\t} else {\n\t\t\tkey = key + \"|\" + filePathName;\n\t\t}\n\n\t\tlet skinData = this._skinAniMapping[key];\n\n\t\tconst self = this;\n\t\tlet isEndCallback = false;\n\t\tlet doCallback = function () {\n\t\t\tskinData = self._skinAniMapping[key];\n\t\t\tif (!skinData) {\n\t\t\t\terror(`\"SpineAniManager:骨骼动画加载失败 找不到该文件key = ${key} path = ${resData.path}`);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (!node || node.isValid == false) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tlet skeleton = node.getComponent(sp.Skeleton);\n\t\t\tskeleton.skeletonData = skinData;\n\t\t\tif (skin) {\n\t\t\t\tskeleton.setSkin(skin);\n\t\t\t}\n\t\t\t//设置开始播放的事件\n\t\t\tskeleton.setStartListener((trackEntry: sp.spine.TrackEntry) => {\n\t\t\t\tif (startCallFunc) {\n\t\t\t\t\tstartCallFunc(trackEntry, skeleton);\n\t\t\t\t}\n\t\t\t});\n\t\t\t//设置播放完成的事件(对于非循环播放动画 由于无播放完成事件 特殊处理)\n\t\t\tskeleton.setEndListener((trackEntry: sp.spine.TrackEntry) => {\n\t\t\t\tSpineAniManager.getInstance().removeSpineNode(node);\n\t\t\t\tif (endCallFunc && isEndCallback == false) {\n\t\t\t\t\tisEndCallback = true;\n\t\t\t\t\tendCallFunc(trackEntry, skeleton);\n\t\t\t\t}\n\t\t\t});\n\t\t\t//设置动画完成一次循环后结束的监听\n\t\t\tskeleton.setCompleteListener((trackEntry: sp.spine.TrackEntry) => {\n\t\t\t\tif (loop == false) {\n\t\t\t\t\tSpineAniManager.getInstance().removeSpineNode(node);\n\t\t\t\t\tif (oneLoopEndCallFunc) {\n\t\t\t\t\t\toneLoopEndCallFunc(trackEntry, skeleton);\n\t\t\t\t\t}\n\t\t\t\t\tif (endCallFunc && isEndCallback == false) {\n\t\t\t\t\t\tisEndCallback = true;\n\t\t\t\t\t\tendCallFunc(trackEntry, skeleton);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif (oneLoopEndCallFunc) {\n\t\t\t\t\t\toneLoopEndCallFunc(trackEntry, skeleton);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t\t//设置动画播放过程中的动作监听\n\t\t\tskeleton.setEventListener((trackEntry: sp.spine.TrackEntry, ev: sp.spine.Event | number) => {\n\t\t\t\tif (processCallFunc) {\n\t\t\t\t\tprocessCallFunc(trackEntry, ev, skeleton);\n\t\t\t\t}\n\t\t\t})\n\n\t\t\t//修改帧更新\n\t\t\tif (frameNum != null && Number(frameNum) > 0) {\n\t\t\t\tif (!skeleton[\"realUpdateAnimation\"]) {\n\t\t\t\t\tskeleton[\"realUpdateAnimation\"] = skeleton.updateAnimation;\n\t\t\t\t}\n\t\t\t\tlet _interval = 0;\n\t\t\t\tlet _max_frame = frameNum;\n\t\t\t\tskeleton.updateAnimation = function (dt) {\n\t\t\t\t\tif ((_interval + dt) < (1 / _max_frame)) {\n\t\t\t\t\t\t_interval = _interval + dt;\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\t_interval = 0;\n\t\t\t\t\tskeleton[\"realUpdateAnimation\"](dt);\n\t\t\t\t}\n\t\t\t}\n\t\t\tskeleton.premultipliedAlpha = premultipliedAlpha;\n\t\t\tskeleton.setAnimation(trackIndex, name, loop);\n\t\t}\n\t\tif (!skinData) {\n\t\t\tthis.print(\"==============再次加载============\")\n\t\t\tthis.preLoadSkinAniDir(resData.bundle, resData.path, null, () => {\n\t\t\t\tdoCallback();\n\t\t\t})\n\t\t} else {\n\t\t\tdoCallback();\n\t\t}\n\t}\n\n}"]}