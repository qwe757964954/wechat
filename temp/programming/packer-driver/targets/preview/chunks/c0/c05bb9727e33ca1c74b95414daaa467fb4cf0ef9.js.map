{"version":3,"sources":["file:///Users/mac/work/WXGame_FlySmallChick/assets/package/game/common/server/ChatServer.ts"],"names":["ChatServer","GCache","Encrypt","EventManager","BaseControll","FXJCMDHead","FXJConstant","FXJEvent","GameEvent","instance","_instance","constructor","name","_handlerCanSendChat","_handlerCanSendInterProp","_handlerCanSendEmoji","onInitModuleEvent","addModelListener","GAME_REQ_PLAYER_CHAET_MSG","reqGameChatMsg","GAME_REQ_PLAYER_CHAET_EMOJI","reqGameChatEmoji","GAME_REQ_EMOJI_PROPS_MSG","reqGameEmojiProps","event","index","text","dispatch","SYS_TOAST_TIP","content","req","msg","sendMsg","cmd","C2S","ROOM_USER_CHAT","body","NET_SEND_MSG","mid","User","getUserMid","VIEW_PLAYER_CHAT_SHOW","stopScheduler","self","addScheduler","QuickChatDelay","num","parseInt","vipType","faceValue","Math","pow","ROOM_USER_FACE","VIEW_PLAYER_EMOJ_SHOW","receiveGameChatMsg","console","log","textObj","JsonDecode","hdInfo","uid","from","prop_id","to_uid","to","VIEW_DESK_ANI_PLAY","AnimNormal","HudongProp"],"mappings":"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","sourcesContent":["/**\n * Name = ChatServer\n * URL = db://assets/package/game/common/server/ChatServer.ts\n * Time = Thu Jul 27 2023 17:20:44 GMT+0800 (中国标准时间)\n * Author = harvyson\n * 聊天服务\n */\n\nimport { GCache } from \"../../../../cache/GCache\";\nimport { Encrypt } from \"../../../../framework/crypto/Encrypto\";\nimport { EventManager } from \"../../../../framework/manager/EventManager\";\nimport { BaseControll } from \"../../../../framework/vc/BaseController\";\nimport { FXJCMDHead } from \"../../net/FXJCmd\";\nimport { FXJConstant } from \"../FXJConstant\";\nimport { FXJEvent } from \"../FXJEvent\";\nimport { GameEvent } from \"../GameEvent\";\n\n\n\nexport interface FaceType {\n    /** vipType  */\n    vipType?: (number | null);\n\n    /** faceValue  */\n    faceValue?: (number | null);\n    /** mid  */\n    mid?: (number | null);\n}\n\nexport interface MsgType {\n    /** vipType  */\n    index?: (number | null);\n    /** faceValue  */\n    msg?: (string | null);\n    /** mid  */\n    mid?: (number | null);\n}\n\n\nexport class ChatServer extends BaseControll {\n    private static _instance = null;\n    public static get instance(): ChatServer {\n        if (!this._instance || this._instance == null) {\n            this._instance = new ChatServer(\"ChatServer\");\n        }\n        return this._instance;\n    }\n    /** 延迟发送文字聊天的句柄 */\n    private _handlerCanSendChat = null;\n\n     /** 延迟发送文字互动道具的句柄 */\n    private _handlerCanSendInterProp = null;\n    \n     /** 延迟发送表情的句柄 */\n     private _handlerCanSendEmoji = null;\n\n    //实例化\n    constructor(name: string = null) {\n        super(name)\n    };\n    /**初始化添加事件绑定 */\n    protected onInitModuleEvent(): void {\n        //请求:文字聊天\n        this.addModelListener(FXJEvent.GAME_REQ_PLAYER_CHAET_MSG, this.reqGameChatMsg);\n        //请求:表情聊天\n        this.addModelListener(FXJEvent.GAME_REQ_PLAYER_CHAET_EMOJI, this.reqGameChatEmoji);\n\n        //请求:互动表情\n        this.addModelListener(FXJEvent.GAME_REQ_EMOJI_PROPS_MSG, this.reqGameEmojiProps);\n    }\n    // let req: Game.ISendOperation = {\n    //     opCard:OperationMgr.getInstance().getSendCardListNumber(index)[0],\n    //     opCode:OPCode.OPE_OUT_CARD,\n    //     opCards:OperationMgr.getInstance().getSendCardListNumber(index),\n    //     seatId:OperationMgr.getInstance().seatId,\n    //     userId:OperationMgr.getInstance().userId\n    // }\n\n\n    /** 请求发送聊天文本 */\n    reqGameChatMsg(event, index, text) {\n        if (index == null || text == null) {\n            return;\n        }\n        if (this._handlerCanSendChat != null) { \n            EventManager.dispatch(FXJEvent.SYS_TOAST_TIP, { content: \"发送太频繁\" });\n            return;\n        }\n        let req: MsgType = {\n            index: index,\n            msg: text,\n        };\n\n        let sendMsg = {\n            cmd: FXJCMDHead.C2S.ROOM_USER_CHAT,\n            body: req,\n        }\n        EventManager.dispatch(FXJEvent.NET_SEND_MSG, sendMsg);\n        req.mid = GCache.User.getUserMid();\n        EventManager.dispatch(FXJEvent.VIEW_PLAYER_CHAT_SHOW, req);\n\n        this.stopScheduler(this._handlerCanSendChat);\n        let self = this;\n        this._handlerCanSendChat = this.addScheduler(FXJConstant.QuickChatDelay, () => { \n            self.stopScheduler(self._handlerCanSendChat);\n            self._handlerCanSendChat = null;\n        })\n    }\n    /** 请求发送表情聊天 */\n    reqGameChatEmoji(event, index) {\n        if (index == null) {\n            return;\n        }\n        if (this._handlerCanSendEmoji != null) { \n            EventManager.dispatch(FXJEvent.SYS_TOAST_TIP, { content: \"发送太频繁\" });\n            return;\n        }\n        \n        const num: number = parseInt(index);\n        let req: FaceType = {\n            vipType: 1,\n            faceValue: num + Math.pow(2, 16),\n        };\n\n        let sendMsg = {\n            cmd: FXJCMDHead.C2S.ROOM_USER_FACE,\n            body: req,\n        }\n        EventManager.dispatch(FXJEvent.NET_SEND_MSG, sendMsg);\n        req.mid = GCache.User.getUserMid();\n        EventManager.dispatch(GameEvent.VIEW_PLAYER_EMOJ_SHOW, req);\n\n        this.stopScheduler(this._handlerCanSendEmoji);\n        let self = this;\n        this._handlerCanSendEmoji = this.addScheduler(FXJConstant.QuickChatDelay, () => { \n            self.stopScheduler(self._handlerCanSendEmoji);\n            self._handlerCanSendEmoji = null;\n        })\n        \n    }\n\n\n    receiveGameChatMsg() {\n\n    }\n\n    /** 请求发送互动道具 */\n    reqGameEmojiProps(event, index, text) {\n        if (index == null || text == null) {\n            return;\n        }\n\n        if (this._handlerCanSendInterProp != null) { \n            EventManager.dispatch(FXJEvent.SYS_TOAST_TIP, { content: \"发送太频繁\" });\n            return;\n        }\n        \n        let req = {\n            index: index, //道具ID\n            msg: text,  // json from  to {from: to:}\n        };\n\n        let sendMsg = {\n            cmd: FXJCMDHead.C2S.ROOM_USER_CHAT,\n            body: req,\n        }\n        console.log(\"reqGameEmojiProps\", sendMsg)\n        EventManager.dispatch(FXJEvent.NET_SEND_MSG, sendMsg);\n\n        let textObj = Encrypt.JsonDecode(text);\n        let hdInfo = {\n\t\t\tuid: textObj.from,\n\t\t\tprop_id: index,\n\t\t\tto_uid:textObj.to,\n        }\n        console.log(\"reqGameEmojiProps1\", hdInfo);\n\t\tEventManager.dispatch(FXJEvent.VIEW_DESK_ANI_PLAY, FXJConstant.AnimNormal.HudongProp, hdInfo);\n\n        this.stopScheduler(this._handlerCanSendInterProp);\n        let self = this;\n        this._handlerCanSendInterProp = this.addScheduler(FXJConstant.QuickChatDelay, () => { \n            self.stopScheduler(self._handlerCanSendInterProp);\n            self._handlerCanSendInterProp = null;\n        })\n        \n    }\n\n}\n\n"]}