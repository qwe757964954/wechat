{"version":3,"sources":["file:///Users/mac/work/WXGame_FlySmallChick/assets/framework/crypto/pbkiller.ts"],"names":["Asset","JsonAsset","path","resources","sys","TextAsset","ProtoBuf","dcodeIO","Long","ByteBuffer","Util","IS_NODE","fetch","url","asset","get","mainFileName","text","json","fileName","idx","lastIndexOf","substring","loadProto","bind","builder","filename","e","console","warn","loadJsonFile","callback","contents","Error","loadJson","JSON","parse","preloaded","content","pbkiller","Map","root","urls","preload","updateFunc","cb","loadDir","finished","total","item","err","data","loadFromFile","fileNames","packageName","isNative","platform","Platform","WECHAT_GAME","error","newBuilder","importRoot","forEach","startsWith","join","extname","mainfilename","loadProtoFile","log","build","loadAll","endsWith","substr","length","files","push","getAssetInfo","_uuid"],"mappings":"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","sourcesContent":["\nimport { Asset, JsonAsset, path, resources, sys, TextAsset } from \"cc\";\n\n// @ts-ignore\nlet ProtoBuf = dcodeIO.ProtoBuf;\n// @ts-ignore\nlet Long = dcodeIO.Long;\n// @ts-ignore\nlet ByteBuffer = dcodeIO.ByteBuffer;\n\n\nProtoBuf.Util.IS_NODE = false;\nProtoBuf.Util.fetch = function (url: string) {\n    let asset: any = resources.get(path.mainFileName(url), Asset);\n    if (asset instanceof TextAsset) {\n        return asset.text;\n    } else if (asset instanceof JsonAsset) {\n        return asset.json;\n    } else {\n        return asset;\n    }\n}\nProtoBuf.Util.mainFileName = function (fileName: string) {\n    if (fileName) {\n        const idx = fileName.lastIndexOf('.');\n        if (idx !== -1) {\n            return fileName.substring(0, idx);\n        }\n    }\n    return fileName;\n}\n/**\n * 加载proto\n */\nlet loadProto = ProtoBuf.loadProto.bind(ProtoBuf);\nProtoBuf.loadProto = function (asset: string | TextAsset, builder: any, filename: string) {\n    try {\n        if (typeof asset === 'string') {\n            loadProto(asset, builder, filename);\n        } else if (asset.text) {\n            loadProto(asset.text, builder, filename);\n        }\n    } catch (e) {\n        console.warn(`${filename}: protobuf syntax error`);\n    }\n};\n\n\n/**\n * 加载json文件 \n */\nProtoBuf.loadJsonFile = function (filename: string, callback: any, builder: any) {\n    if (callback && typeof callback === 'object')\n        builder = callback,\n            callback = null;\n    else if (!callback || typeof callback !== 'function')\n        callback = null;\n    if (callback)\n        return ProtoBuf.Util.fetch(typeof filename === 'string' ? filename : filename[\"root\"] + \"/\" + filename[\"file\"], function (contents) {\n            if (contents === null) {\n                callback(Error(\"Failed to fetch file\"));\n                return;\n            }\n            try {\n                callback(null, ProtoBuf.loadJson(JSON.parse(contents), builder, filename));\n            } catch (e) {\n                callback(e);\n            }\n        });\n\n    let url = typeof filename === 'object' ? filename[\"root\"] + \"/\" + filename[\"file\"] : filename;\n    let json;\n    if (ProtoBuf.preloaded) {\n        let content = resources.get(url, Asset);\n        if (content instanceof JsonAsset) {\n            json = content.json\n        } else {\n            // @ts-ignore\n            json = console.text;\n        }\n\n    } else {\n        let content = ProtoBuf.Util.fetch(url);\n        if (content) {\n            json = JSON.parse(content);\n        }\n    }\n\n    return json ? ProtoBuf.loadJson(json, builder, filename) : null;\n};\n\nconst pbkiller = {\n    //类型\n    ProtoBuf: ProtoBuf,\n    Long: Long,\n    ByteBuffer: ByteBuffer,\n    Map: ProtoBuf.Map,\n    root: 'proto',  //定义pb路径 默认resource/.. 下\n    urls: [],\n\n    preload(updateFunc: Function = null, cb: Function = null) {\n        resources.loadDir(\n            pbkiller.root,\n            (finished: number, total: number, item) => {\n                if (updateFunc) {\n                    updateFunc(finished, total, item);\n                }\n\n            },\n            (err, data: any) => {\n                ProtoBuf.preloaded = !err;\n                pbkiller.urls = data;\n                if (cb) {\n                    cb(err, data);\n                }\n            });\n    },\n    /**\n     * 加载文件proto文件，支持json、proto格式\n     * @param {String|Array} files \n     */\n    loadFromFile(fileNames: Array<string> | string, packageName: string) {\n        if ((sys.isNative || sys.platform === sys.Platform.WECHAT_GAME) && !ProtoBuf.preloaded) {\n            console.error('原生或微信小游戏上，需要先调用preload函数');\n            return;\n        }\n        if (typeof fileNames === 'string') {\n            fileNames = [fileNames];\n        }\n\n        let builder = ProtoBuf.newBuilder();\n        builder.importRoot = pbkiller.root;\n\n        fileNames.forEach((fileName: string) => {\n            if (!fileName.startsWith(pbkiller.root)) {\n                fileName = path.join(pbkiller.root, fileName);\n            }\n            let extname = path.extname(fileName);\n            let mainfilename = path.mainFileName(fileName);\n            if (extname === '.proto') {\n                ProtoBuf.loadProtoFile(mainfilename, builder);\n            } else {\n                console.log(`nonsupport file extname, only support 'proto'`);\n            }\n        });\n\n        return builder.build(packageName);\n    },\n\n    /**\n     * 加载所有proto文件\n     * @param {String} extname \n     * @param {String} packageName \n     */\n    loadAll(packageName = ''): any {\n        if (pbkiller.root.endsWith('/') || pbkiller.root.endsWith('\\\\')) {\n            pbkiller.root = pbkiller.root.substr(0, pbkiller.root.length - 1);\n        }\n\n        //获取pbkiller.root下的所有文件名\n        let files: Array<string> = [];\n        this.urls.forEach((asset: Asset) => {\n            if (asset instanceof TextAsset) {\n                // @ts-ignore\n                files.push(`${resources.getAssetInfo(asset._uuid).path}.proto`);\n            }\n        });\n        return this.loadFromFile(files, packageName);\n    }\n}\n\nexport { pbkiller };\n"]}